AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Travel Guide Core Infrastructure - S3 Buckets, DynamoDB Tables, Cognito
Parameters:
  Environment:
    Type: String
    Default: staging
    AllowedValues: [staging, prod]
    Description: Environment name
  CorsOrigin:
    Type: String
    Default: "*"
    Description: CORS origin for API Gateway
  AdminEmail:
    Type: String
    Default: "admin@example.com"
    Description: Admin email for notifications (must be verified in SES)
Conditions:
  IsProd: !Equals [!Ref Environment, prod]
Resources:
  ##############################
  # S3 BUCKETS
  ##############################
  ArticleImagesBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub travel-guide-images-${Environment}-${AWS::AccountId}
      VersioningConfiguration:
        Status: Enabled
      CorsConfiguration:
        CorsRules:
          - AllowedMethods: 
              - "GET"
              - "PUT"
              - "POST"
              - "DELETE"
              - "HEAD"
            AllowedOrigins: 
              - !Ref CorsOrigin
            AllowedHeaders: 
              - "*"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
  
  StaticSiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub travel-guide-static-${Environment}-${AWS::AccountId}
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
  
  ##############################
  # DYNAMODB TABLES
  ##############################
  ArticlesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub articles-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: articleId
          AttributeType: S
        - AttributeName: visibility
          AttributeType: S
        - AttributeName: createdAt
          AttributeType: S
        - AttributeName: ownerId
          AttributeType: S
        - AttributeName: gh5
          AttributeType: S
        - AttributeName: geohash
          AttributeType: S
      KeySchema:
        - AttributeName: articleId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: gsi_visibility_createdAt
          KeySchema:
            - AttributeName: visibility
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: gsi_owner_createdAt
          KeySchema:
            - AttributeName: ownerId
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: gsi_gh5_geohash
          KeySchema:
            - AttributeName: gh5
              KeyType: HASH
            - AttributeName: geohash
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
  
  UserFavoritesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub user-favorites-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
        - AttributeName: articleId
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
        - AttributeName: articleId
          KeyType: RANGE

  GalleryPhotosTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub gallery-photos-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: photo_id
          AttributeType: S
      KeySchema:
        - AttributeName: photo_id
          KeyType: HASH

  GalleryTrendsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub gallery-trends-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: tag_name
          AttributeType: S
      KeySchema:
        - AttributeName: tag_name
          KeyType: HASH

  UserProfilesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub user-profiles-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH

  LocationCacheTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub location-cache-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: geohash
          AttributeType: S
      KeySchema:
        - AttributeName: geohash
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
  
  ##############################
  # COGNITO USER POOL
  ##############################
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub TravelGuideUserPool-${Environment}
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireUppercase: true
          RequireNumbers: true
          RequireSymbols: false
      AutoVerifiedAttributes:
        - email
      Schema:
        - Name: email
          AttributeDataType: String
          Mutable: false
          Required: true
      EmailConfiguration:
        EmailSendingAccount: COGNITO_DEFAULT
  
  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub web-client-${Environment}
      UserPoolId: !Ref UserPool
      GenerateSecret: false
      ExplicitAuthFlows:
        - USER_PASSWORD_AUTH
      PreventUserExistenceErrors: ENABLED
  
  ##############################
  # CLOUDFRONT
  ##############################
  CloudFrontOAI:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: !Sub "OAI for Travel Guide ${Environment}"
  
  StaticSiteBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref StaticSiteBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowCloudFrontOAIReadOnly
            Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity ${CloudFrontOAI}"
            Action: "s3:GetObject"
            Resource: !Sub "${StaticSiteBucket.Arn}/*"
  
  ArticleImagesBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ArticleImagesBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowCloudFrontOAIReadImages
            Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity ${CloudFrontOAI}"
            Action: "s3:GetObject"
            Resource: !Sub "${ArticleImagesBucket.Arn}/*"
  
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Origins:
          - Id: S3OriginStatic
            DomainName: !GetAtt StaticSiteBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: !Sub "origin-access-identity/cloudfront/${CloudFrontOAI}"
          - Id: S3OriginImages
            DomainName: !GetAtt ArticleImagesBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: !Sub "origin-access-identity/cloudfront/${CloudFrontOAI}"
        Enabled: true
        DefaultRootObject: index.html
        DefaultCacheBehavior:
          TargetOriginId: S3OriginStatic
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods: 
            - "GET"
            - "HEAD"
          CachedMethods: 
            - "GET"
            - "HEAD"
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
          Compress: true
        CacheBehaviors:
          - PathPattern: "articles/*"
            TargetOriginId: S3OriginImages
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods: 
              - "GET"
              - "HEAD"
            CachedMethods: 
              - "GET"
              - "HEAD"
            ForwardedValues:
              QueryString: false
              Cookies:
                Forward: none
            Compress: true
          - PathPattern: "thumbnails/*"
            TargetOriginId: S3OriginImages
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods: 
              - "GET"
              - "HEAD"
            CachedMethods: 
              - "GET"
              - "HEAD"
            ForwardedValues:
              QueryString: false
              Cookies:
                Forward: none
            Compress: true
        PriceClass: PriceClass_100
        HttpVersion: http2
        IPV6Enabled: true
        ViewerCertificate:
          CloudFrontDefaultCertificate: true
          MinimumProtocolVersion: TLSv1.2_2021

  ##############################
  # AWS LOCATION SERVICE
  ##############################
  TravelGuidePlaceIndex:
    Type: AWS::Location::PlaceIndex
    Properties:
      IndexName: !Sub TravelGuidePlaceIndex-${Environment}
      DataSource: Esri
      DataSourceConfiguration:
        IntendedUse: SingleUse
      Description: Place index for reverse geocoding with global coverage
      PricingPlan: RequestBasedUsage

  ##############################
  # SNS TOPIC FOR ADMIN NOTIFICATIONS
  ##############################
  AdminNotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub travel-guide-${Environment}-admin-notifications
      DisplayName: Admin Notifications for Critical Content

  AdminNotificationEmailSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: email
      TopicArn: !Ref AdminNotificationTopic
      Endpoint: !Ref AdminEmail
          
  ##############################
  # SQS QUEUES FOR IMAGE PROCESSING
  ##############################
  ImageProcessingDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub travel-guide-${Environment}-image-processing-dlq
      MessageRetentionPeriod: 1209600
      VisibilityTimeout: 300

  DetectLabelsQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub travel-guide-${Environment}-detect-labels-queue
      VisibilityTimeout: 300
      MessageRetentionPeriod: 345600
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt ImageProcessingDLQ.Arn
        maxReceiveCount: 3

  ContentModerationQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub travel-guide-${Environment}-content-moderation-queue
      VisibilityTimeout: 300
      MessageRetentionPeriod: 345600
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt ImageProcessingDLQ.Arn
        maxReceiveCount: 3

  ImageProcessingQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub travel-guide-${Environment}-image-processing-queue
      VisibilityTimeout: 300
      MessageRetentionPeriod: 345600
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt ImageProcessingDLQ.Arn
        maxReceiveCount: 3

  ThumbnailQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub travel-guide-${Environment}-thumbnail-queue
      VisibilityTimeout: 180
      MessageRetentionPeriod: 345600
      ReceiveMessageWaitTimeSeconds: 20
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt ImageProcessingDLQ.Arn
        maxReceiveCount: 3

  ImageValidatorQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub travel-guide-${Environment}-image-validator-queue
      VisibilityTimeout: 180
      MessageRetentionPeriod: 345600
      ReceiveMessageWaitTimeSeconds: 20
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt ImageProcessingDLQ.Arn
        maxReceiveCount: 3

  ImageAnalyzerQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub travel-guide-${Environment}-image-analyzer-queue
      VisibilityTimeout: 180
      MessageRetentionPeriod: 345600
      ReceiveMessageWaitTimeSeconds: 20
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt ImageProcessingDLQ.Arn
        maxReceiveCount: 3

  NotificationQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub travel-guide-${Environment}-notification-queue
      VisibilityTimeout: 180
      MessageRetentionPeriod: 345600
      ReceiveMessageWaitTimeSeconds: 20
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt ImageProcessingDLQ.Arn
        maxReceiveCount: 3

  ##############################
  # SQS QUEUE POLICIES
  ##############################
  DetectLabelsQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref DetectLabelsQueue
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action:
              - sqs:SendMessage
            Resource: !GetAtt DetectLabelsQueue.Arn
            Condition:
              ArnLike:
                aws:SourceArn: !GetAtt ArticleImagesBucket.Arn

  ContentModerationQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref ContentModerationQueue
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action:
              - sqs:SendMessage
            Resource: !GetAtt ContentModerationQueue.Arn
            Condition:
              ArnLike:
                aws:SourceArn: !GetAtt ArticleImagesBucket.Arn

  ImageProcessingQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref ImageProcessingQueue
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action:
              - sqs:SendMessage
            Resource: !GetAtt ImageProcessingQueue.Arn
            Condition:
              ArnLike:
                aws:SourceArn: !GetAtt ArticleImagesBucket.Arn

  ThumbnailQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref ThumbnailQueue
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action:
              - sqs:SendMessage
            Resource: !GetAtt ThumbnailQueue.Arn
            Condition:
              ArnLike:
                aws:SourceArn: !GetAtt ArticleImagesBucket.Arn

  ImageValidatorQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref ImageValidatorQueue
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action:
              - sqs:SendMessage
            Resource: !GetAtt ImageValidatorQueue.Arn
            Condition:
              ArnLike:
                aws:SourceArn: !GetAtt ArticleImagesBucket.Arn

  ImageAnalyzerQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref ImageAnalyzerQueue
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action:
              - sqs:SendMessage
            Resource: !GetAtt ImageAnalyzerQueue.Arn
            Condition:
              ArnLike:
                aws:SourceArn: !GetAtt ArticleImagesBucket.Arn

  ##############################
  # CLOUDWATCH ALARMS
  ##############################
  DLQAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub travel-guide-${Environment}-dlq-messages
      AlarmDescription: Alert when messages appear in DLQ
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: QueueName
          Value: !GetAtt ImageProcessingDLQ.QueueName

Outputs:
  # Article Service needs these outputs
  ArticlesTableArn:
    Value: !GetAtt ArticlesTable.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ArticlesTableArn"
  ArticlesTableName:
    Value: !Ref ArticlesTable
    Export:
      Name: !Sub "${AWS::StackName}-ArticlesTableName"
  ArticleImagesBucketName:
    Value: !Ref ArticleImagesBucket
    Export:
      Name: !Sub "${AWS::StackName}-ArticleImagesBucketName"
  ArticleImagesBucketArn:
    Value: !GetAtt ArticleImagesBucket.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ArticleImagesBucketArn"
  StaticSiteBucketName:
    Value: !Ref StaticSiteBucket
    Export:
      Name: !Sub "${AWS::StackName}-StaticSiteBucketName"
  UserFavoritesTableName:
    Value: !Ref UserFavoritesTable
    Export:
      Name: !Sub "${AWS::StackName}-UserFavoritesTableName"
  # Auth Service needs these outputs
  UserPoolId:
    Value: !Ref UserPool
    Export:
      Name: !Sub "${AWS::StackName}-UserPoolId"
  UserPoolClientId:
    Value: !Ref UserPoolClient
    Export:
      Name: !Sub "${AWS::StackName}-UserPoolClientId"
  CloudFrontDomain:
    Value: !GetAtt CloudFrontDistribution.DomainName
    Export:
      Name: !Sub "${AWS::StackName}-CloudFrontDomain"
  # Media and AI Service needs these outputs
  ImageProcessingDLQUrl:
    Value: !Ref ImageProcessingDLQ
    Export:
      Name: !Sub "${AWS::StackName}-ImageProcessingDLQUrl"
  ImageProcessingDLQArn:
    Value: !GetAtt ImageProcessingDLQ.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ImageProcessingDLQArn"
  DetectLabelsQueueUrl:
    Value: !Ref DetectLabelsQueue
    Export:
      Name: !Sub "${AWS::StackName}-DetectLabelsQueueUrl"
  DetectLabelsQueueArn:
    Value: !GetAtt DetectLabelsQueue.Arn
    Export:
      Name: !Sub "${AWS::StackName}-DetectLabelsQueueArn"
  ContentModerationQueueUrl:
    Value: !Ref ContentModerationQueue
    Export:
      Name: !Sub "${AWS::StackName}-ContentModerationQueueUrl"
  ContentModerationQueueArn:
    Value: !GetAtt ContentModerationQueue.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ContentModerationQueueArn"
  ImageProcessingQueueUrl:
    Value: !Ref ImageProcessingQueue
    Export:
      Name: !Sub "${AWS::StackName}-ImageProcessingQueueUrl"
  ImageProcessingQueueArn:
    Value: !GetAtt ImageProcessingQueue.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ImageProcessingQueueArn"
  
  # Thumbnail Queue
  ThumbnailQueueUrl:
    Value: !Ref ThumbnailQueue
    Export:
      Name: !Sub "${AWS::StackName}-ThumbnailQueueUrl"
  ThumbnailQueueArn:
    Value: !GetAtt ThumbnailQueue.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ThumbnailQueueArn"
  
  # Image Validator Queue
  ImageValidatorQueueUrl:
    Value: !Ref ImageValidatorQueue
    Export:
      Name: !Sub "${AWS::StackName}-ImageValidatorQueueUrl"
  ImageValidatorQueueArn:
    Value: !GetAtt ImageValidatorQueue.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ImageValidatorQueueArn"
  
  # Image Analyzer Queue
  ImageAnalyzerQueueUrl:
    Value: !Ref ImageAnalyzerQueue
    Export:
      Name: !Sub "${AWS::StackName}-ImageAnalyzerQueueUrl"
  ImageAnalyzerQueueArn:
    Value: !GetAtt ImageAnalyzerQueue.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ImageAnalyzerQueueArn"
  
  # Notification Queue
  NotificationQueueUrl:
    Value: !Ref NotificationQueue
    Export:
      Name: !Sub "${AWS::StackName}-NotificationQueueUrl"
  NotificationQueueArn:
    Value: !GetAtt NotificationQueue.Arn
    Export:
      Name: !Sub "${AWS::StackName}-NotificationQueueArn"
  NotificationQueueName:
    Value: !GetAtt NotificationQueue.QueueName
    Export:
      Name: !Sub "${AWS::StackName}-NotificationQueueName"
  
  # Gallery Tables
  GalleryPhotosTableName:
    Value: !Ref GalleryPhotosTable
    Export:
      Name: !Sub "${AWS::StackName}-GalleryPhotosTableName"
  GalleryPhotosTableArn:
    Value: !GetAtt GalleryPhotosTable.Arn
    Export:
      Name: !Sub "${AWS::StackName}-GalleryPhotosTableArn"
  GalleryTrendsTableName:
    Value: !Ref GalleryTrendsTable
    Export:
      Name: !Sub "${AWS::StackName}-GalleryTrendsTableName"
  GalleryTrendsTableArn:
    Value: !GetAtt GalleryTrendsTable.Arn
    Export:
      Name: !Sub "${AWS::StackName}-GalleryTrendsTableArn"
  
  # User Profiles Table
  UserProfilesTableName:
    Value: !Ref UserProfilesTable
    Export:
      Name: !Sub "${AWS::StackName}-UserProfilesTableName"
  UserProfilesTableArn:
    Value: !GetAtt UserProfilesTable.Arn
    Export:
      Name: !Sub "${AWS::StackName}-UserProfilesTableArn"
  
  # Location Cache Table
  LocationCacheTableName:
    Value: !Ref LocationCacheTable
    Export:
      Name: !Sub "${AWS::StackName}-LocationCacheTableName"
  LocationCacheTableArn:
    Value: !GetAtt LocationCacheTable.Arn
    Export:
      Name: !Sub "${AWS::StackName}-LocationCacheTableArn"
  
  # AWS Location Service
  PlaceIndexName:
    Value: !Ref TravelGuidePlaceIndex
    Export:
      Name: !Sub "${AWS::StackName}-PlaceIndexName"
  PlaceIndexArn:
    Value: !GetAtt TravelGuidePlaceIndex.IndexArn
    Export:
      Name: !Sub "${AWS::StackName}-PlaceIndexArn"
  
  # SNS Topic
  AdminSNSTopicArn:
    Value: !Ref AdminNotificationTopic
    Export:
      Name: !Sub "${AWS::StackName}-AdminSNSTopicArn"
  
  # User Favorites Table Arn (for policies)
  UserFavoritesTableArn:
    Value: !GetAtt UserFavoritesTable.Arn
    Export:
      Name: !Sub "${AWS::StackName}-UserFavoritesTableArn"