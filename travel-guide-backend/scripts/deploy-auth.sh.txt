#!/usr/bin/env bash
set -euo pipefail
#################################
# Travel Guide - Deploy Auth    #
#################################

cleanup() {
  local exit_code=$?
  if [[ $exit_code -ne 0 ]]; then
    echo ""
    echo "========================================"
    echo " ðŸš¨  DEPLOY AUTH SERVICE FAILED"
    echo "========================================"
    echo "Exit code : $exit_code"
    echo "Last cmd  : ${BASH_COMMAND}"
    echo ""
    echo " ðŸ’¡  Gá»£i Ã½:"
    echo "  - Kiá»ƒm tra template vÃ  parameters cá»§a auth-service"
    echo "  - Kiá»ƒm tra AWS credentials (aws sts get-caller-identity)"
    echo "  - Xem log CloudFormation:"
    echo "    aws cloudformation describe-stack-events \\"
    echo "      --stack-name travel-guide-auth-$ENV \\"
    echo "      --region $REGION \\"
    echo "      --profile $PROFILE | head -n 40"
    echo ""
    read -p "Press Enter to exit..."
  fi
}
trap cleanup EXIT

log()  { echo -e "[$(date '+%H:%M:%S')] $*"; }
fail() { echo -e " âŒ  $*" >&2; exit 1; }

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Xá»­ lÃ½ tham sá»‘ Ä‘áº§u vÃ o (bÃ¢y giá» cÃ³ 4 tham sá»‘)
ENV="${1:-staging}"
REGION="${2:-us-east-1}"
PROFILE="${3:-default}"
DEPLOY_BUCKET="${4:-}"  # ThÃªm tham sá»‘ DEPLOY_BUCKET

SERVICE_NAME="auth"
STACK_NAME="travel-guide-${SERVICE_NAME}-${ENV}"
SERVICE_DIR="$ROOT_DIR/services/${SERVICE_NAME}-service"
TEMPLATE_FILE="$SERVICE_DIR/template.yaml"
PARAM_FILE="$SERVICE_DIR/parameters/${ENV}.json"

log " ðŸš¢  Deploy AUTH SERVICE"
log "  ENV     : $ENV"
log "  REGION  : $REGION"
log "  PROFILE : $PROFILE"
log "  BUCKET  : $DEPLOY_BUCKET"
log "  STACK   : $STACK_NAME"
log "  DIR     : $SERVICE_DIR"
log "  TEMPLATE: $TEMPLATE_FILE"
log "  PARAMS  : $PARAM_FILE"
echo ""

# Kiá»ƒm tra cÃ´ng cá»¥ cáº§n thiáº¿t
command -v aws >/dev/null 2>&1 || fail "KhÃ´ng tÃ¬m tháº¥y 'aws' CLI"
command -v sam >/dev/null 2>&1 || fail "KhÃ´ng tÃ¬m tháº¥y 'sam' CLI"

# Táº¡o thÆ° má»¥c parameters náº¿u chÆ°a tá»“n táº¡i
mkdir -p "$(dirname "$PARAM_FILE")"

# Tá»± Ä‘á»™ng táº¡o file parameters náº¿u chÆ°a cÃ³
if [[ ! -f "$PARAM_FILE" ]]; then
  log " âš™ï¸   Táº¡o file parameters máº·c Ä‘á»‹nh táº¡i $PARAM_FILE"
  cat > "$PARAM_FILE" <<EOF
{
  "CoreStackName": "travel-guide-core-$ENV",
  "Environment": "$ENV",
  "CorsOrigin": "*"
}
EOF
  log " âœ…    File parameters Ä‘Ã£ Ä‘Æ°á»£c táº¡o"
fi

# Kiá»ƒm tra láº¡i
[[ -d "$SERVICE_DIR"    ]] || fail "KhÃ´ng tÃ¬m tháº¥y service dir: $SERVICE_DIR"
[[ -f "$TEMPLATE_FILE"  ]] || fail "KhÃ´ng tÃ¬m tháº¥y template: $TEMPLATE_FILE"
[[ -f "$PARAM_FILE"     ]] || fail "KhÃ´ng tÃ¬m tháº¥y params: $PARAM_FILE"

params_from_json() {
  local param_file="$1"
  
  if command -v jq >/dev/null 2>&1; then
    # Chuyá»ƒn Ä‘á»•i thÃ nh chuá»—i má»™t dÃ²ng vá»›i cÃ¡c parameter cÃ¡ch nhau báº±ng dáº¥u cÃ¡ch
    jq -r 'to_entries | map("\(.key)=\(.value|tostring)") | join(" ")' "$param_file"
  elif command -v python3 >/dev/null 2>&1; then
    python3 - <<PY
import json
from pathlib import Path
data = json.loads(Path("$param_file").read_text(encoding="utf-8"))
print(" ".join(f"{k}={v}" for k, v in data.items()))
PY
  else
    fail "Cáº§n cÃ³ 'jq' hoáº·c 'python3' Ä‘á»ƒ convert parameters."
  fi
}

log " ðŸ”§  sam build (auth-service)..."
pushd "$SERVICE_DIR" >/dev/null
sam build
popd >/dev/null

echo ""
log " ðŸ”„  Convert parameters..."
PARAM_OVERRIDES=$(params_from_json "$PARAM_FILE")
echo "    - $PARAM_OVERRIDES"
echo ""

log " ðŸš¢  sam deploy (auth-service)..."
sam deploy \
  --stack-name "$STACK_NAME" \
  --template-file "$TEMPLATE_FILE" \
  --region "$REGION" \
  --profile "$PROFILE" \
  --s3-bucket "$DEPLOY_BUCKET" \
  --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND \
  --no-confirm-changeset \
  --no-fail-on-empty-changeset \
  --parameter-overrides "$PARAM_OVERRIDES"

log " âœ…  AUTH SERVICE deploy thÃ nh cÃ´ng"